Kybelix-Agri-AI: How It Connects And Works

Overview
- Entry point: train.py
- Configuration: config.py
- Data loading: src/data/dataset.py
- Models: src/models/*
- Loss + metrics: src/utils/losses.py, src/utils/metrics.py

Data Flow
1) Config sets device, dataset paths, model choice, training hyperparameters.
2) train.py builds datasets using GIDDataset with image and mask directories from Config.
3) DataLoader yields batches of images and binary masks.
4) Model is created by src/models/model_factory.get_model.
5) Forward pass produces logits for segmentation.
6) Loss computed by FocalTverskyLoss; IoU metric computed by get_iou_score.
7) Optimizer updates model; checkpoints saved under Config.CHECKPOINT_DIR.

Dataset Handling
- src/data/dataset.py contains the single dataset implementation.
- GIDDataset loads images/masks by matching base filenames (ignores extensions),
  reads with OpenCV imdecode for Unicode path safety, then converts to RGB.
- Mask is created by selecting pixels that match Config.TARGET_COLOR (default [0,255,0]).
- If transform is provided, it is applied to both image and mask; otherwise tensors
  are created directly.
- GIDSegmentationDataset is a compatibility wrapper that accepts a base_dir + split
  and forwards to GIDDataset.

Models
- get_model in src/models/model_factory.py selects a model by name:
  b0, b4, ghostnet.
- Model classes live in src/models/unet.py, unetpp.py, and deeplab.py.

Training Loop (train.py)
- Mixed precision is enabled automatically on CUDA.
- Each epoch trains, then validates.
- Checkpoints are saved atomically to avoid corruption:
  * {model}_last.pth
  * {model}_epoch###.pth
  * {model}_best.pth

Notes
- There is a single dataset module now: src/data/dataset.py.
- If any code previously imported src/dataset.py, use src.data.dataset instead.

How To Use
1) Install dependencies.
   pip install -r requirements.txt
   Also required at runtime:
   pip install opencv-python tqdm
2) Place the dataset under ./phase1data (or update Config.SHORTCUT_NAME/paths).
   Expected structure:
   ./phase1data/unmasked/train
   ./phase1data/unmasked/val
   ./phase1data/unmasked/test
   ./phase1data/masked/train
   ./phase1data/masked/val
3) If you are using Google Drive in Colab, the code will automatically resolve:
   /content/drive/MyDrive/phase1data
   Otherwise it uses the local relative path ./phase1data.
4) IMPORTANT: The current dataset loader expects images and masks to be files
   directly inside the train/val/test folders. If your data is organized into
   additional subfolders, the loader must be updated to recurse.
5) Dataset requirements:
   - Image and mask filenames must match by base name (ignores extensions).
   - Masks should be RGB images with the target color defined in Config.TARGET_COLOR.
   - Default target color is [0, 255, 0] (green).
6) Configure training in config.py:
   - MODEL_NAME: b0, b4, ghostnet
   - BATCH_SIZE, EPOCHS, LEARNING_RATE, IMAGE_SIZE
   - TARGET_COLOR for mask extraction
7) Train:
   python3 train.py
8) Checkpoints are saved to ./checkpoints.

Training And Resuming
- Full training (default config):
  python3 train.py
- Custom training from code (example; edit train.py or import train in a script):
  python3 -c "from train import train; train(model_name='b4', epochs=5)"
- Resume from a checkpoint (CLI):
  python3 train.py --resume checkpoints/<run_name>/b4_last.pth
- Resume using config (no CLI needed):
  Set in config.py:
  RESUME_PATH = "checkpoints/<run_name>/b4_last.pth"
  RESET_OPTIMIZER = False  # set True if you changed LR and want fresh optimizer state
- If you see an error like "invalid load key":
  The resume path likely points to a non-checkpoint file. Use a .pth/.pt/.ckpt
  file generated by this training script.
